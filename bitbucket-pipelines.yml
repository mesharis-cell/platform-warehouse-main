# =============================================================================
# Bitbucket to GitHub Sync Pipeline
# =============================================================================
# Purpose: Automatically mirror all pushes from Bitbucket to GitHub
# Trigger: Every push to any branch
# =============================================================================

image: alpine/git

definitions:
  steps:
    - step: &sync-to-github
        name: Sync to GitHub
        script:
          # ---------------------------------------------------------------------
          # SSH Setup
          # ---------------------------------------------------------------------
          - mkdir -p ~/.ssh
          - echo "$GITHUB_SSH_KEY" > ~/.ssh/id_ed25519
          - chmod 600 ~/.ssh/id_ed25519
          - ssh-keyscan -t ed25519,rsa github.com >> ~/.ssh/known_hosts
          
          # ---------------------------------------------------------------------
          # Git Configuration
          # ---------------------------------------------------------------------
          - git config --global user.email "pipeline@bitbucket.org"
          - git config --global user.name "Bitbucket Pipeline"
          
          # ---------------------------------------------------------------------
          # Add GitHub Remote
          # ---------------------------------------------------------------------
          - git remote add github git@github.com:homeofpmg/platform-warehouse-main.git || git remote set-url github git@github.com:homeofpmg/platform-warehouse-main.git
          
          # ---------------------------------------------------------------------
          # Push Current Branch
          # ---------------------------------------------------------------------
          - echo "Syncing branch $BITBUCKET_BRANCH to GitHub..."
          - git push github $BITBUCKET_BRANCH --force
          
          # ---------------------------------------------------------------------
          # Sync Tags (if any exist)
          # ---------------------------------------------------------------------
          - git push github --tags || true

pipelines:
  # ---------------------------------------------------------------------------
  # Default Pipeline - Runs on all branches
  # ---------------------------------------------------------------------------
  default:
    - step: *sync-to-github

  # ---------------------------------------------------------------------------
  # Main Branch Pipeline - Full mirror including all refs
  # ---------------------------------------------------------------------------
  branches:
    main:
      - step:
          name: Full Mirror to GitHub
          script:
            # SSH Setup
            - mkdir -p ~/.ssh
            - echo "$GITHUB_SSH_KEY" > ~/.ssh/id_ed25519
            - chmod 600 ~/.ssh/id_ed25519
            - ssh-keyscan -t ed25519,rsa github.com >> ~/.ssh/known_hosts
            
            # Git Configuration
            - git config --global user.email "pipeline@bitbucket.org"
            - git config --global user.name "Bitbucket Pipeline"
            
            # Add GitHub Remote
            - git remote add github git@github.com:homeofpmg/platform-warehouse-main.git || git remote set-url github git@github.com:homeofpmg/platform-warehouse-main.git
            
            # Fetch full history (Bitbucket clones are shallow by default)
            - git fetch --unshallow || true
            - git fetch origin '+refs/heads/*:refs/heads/*' '+refs/tags/*:refs/tags/*' || true
            
            # Full mirror push (all branches, all tags)
            - echo "Performing full mirror to GitHub..."
            - git push github --mirror

  # ---------------------------------------------------------------------------
  # Pull Request Pipeline - Skip sync for PRs (optional)
  # ---------------------------------------------------------------------------
  pull-requests:
    '**':
      - step:
          name: Skip Sync for PRs
          script:
            - echo "Skipping GitHub sync for pull request builds"
